amends "../../pkg/schemas/Config.pkl"

docker {
  networks {
    ["microservices-net"] {
      driver = "bridge"
    }
  }

  volumes {
    ["postgres_data"] {}
    ["redis_data"] {}
    ["minio_data"] {}
    ["prometheus_data"] {}
    ["grafana_data"] {}
  }

  containers {
    // ----------------------------------------------------------
    // API GATEWAY / REVERSE PROXY
    // ----------------------------------------------------------
    ["reverse-proxy"] {
      image = "traefik:v3.0"
      command {
        "--api.dashboard=true"
        "--providers.docker=true"
        "--providers.docker.exposedbydefault=false"
        "--entrypoints.web.address=:80"
      }
      ports {
        ["8090"] = 80
        ["8081"] = 8080
      }
      volumes {
        "/var/run/docker.sock:/var/run/docker.sock:ro"
      }
      networks { "microservices-net" }
    }

    // ----------------------------------------------------------
    // REST API (Node.js / Express)
    // ----------------------------------------------------------
    ["node-api"] {
      image = "node:20-alpine"
      // working_dir/labels not yet in schema, using env/command for specific config
      command { "sh"; "-c"; "npm install && node index.js" }
      volumes {
        "./services/rest-api:/app"
      }
      env {
        ["PORT"] = "3000"
        ["DATABASE_URL"] = "postgres://app:app@postgres-db:5432/app"
        ["REDIS_URL"] = "redis://redis-cache:6379"
        ["S3_ENDPOINT"] = "http://minio-storage:9000"
        ["S3_ACCESS_KEY"] = "minioadmin"
        ["S3_SECRET_KEY"] = "minioadmin"
      }
      // Note: Labels/WorkingDir support would need schema updates. 
      // For now we map what we can.
      dependsOn {
        "postgres-db"
        "redis-cache"
        "minio-storage"
      }
      networks { "microservices-net" }
    }

    // ----------------------------------------------------------
    // gRPC API (Go)
    // ----------------------------------------------------------
    ["go-api"] {
      image = "golang:1.23-alpine"
      command { "sh"; "-c"; "go mod tidy && go run main.go" }
      volumes {
        "./services/grpc-api:/app"
      }
      env {
        ["GRPC_PORT"] = "50051"
      }
      networks { "microservices-net" }
    }

    // ----------------------------------------------------------
    // WEBSOCKET API
    // ----------------------------------------------------------
    ["ws-api"] {
      image = "node:20-alpine"
      command { "sh"; "-c"; "npm install && node ws.js" }
      volumes {
        "./services/websocket-api:/app"
      }
      env {
        ["PORT"] = "4000"
      }
      networks { "microservices-net" }
    }

    // ----------------------------------------------------------
    // POSTGRESQL
    // ----------------------------------------------------------
    ["postgres-db"] {
      image = "postgres:16"
      env {
        ["POSTGRES_USER"] = "app"
        ["POSTGRES_PASSWORD"] = "app"
        ["POSTGRES_DB"] = "app"
      }
      volumes {
        "postgres_data:/var/lib/postgresql/data"
      }
      ports {
        ["5433"] = 5432
      }
      networks { "microservices-net" }
    }

    // ----------------------------------------------------------
    // REDIS
    // ----------------------------------------------------------
    ["redis-cache"] {
      image = "redis:7"
      command { "redis-server"; "--appendonly"; "yes" }
      volumes {
        "redis_data:/data"
      }
      networks { "microservices-net" }
    }

    // ----------------------------------------------------------
    // MINIO
    // ----------------------------------------------------------
    ["minio-storage"] {
      image = "minio/minio:latest"
      command { "server"; "/data"; "--console-address"; ":9001" }
      env {
        ["MINIO_ROOT_USER"] = "minioadmin"
        ["MINIO_ROOT_PASSWORD"] = "minioadmin"
      }
      volumes {
        "minio_data:/data"
      }
      ports {
        ["9005"] = 9000
        ["9006"] = 9001
      }
      networks { "microservices-net" }
    }

    // ----------------------------------------------------------
    // PROMETHEUS
    // ----------------------------------------------------------
    ["prometheus-metrics"] {
      image = "prom/prometheus:latest"
      volumes {
        "./observability/prometheus.yml:/etc/prometheus/prometheus.yml"
        "prometheus_data:/prometheus"
      }
      ports {
        ["9099"] = 9090
      }
      networks { "microservices-net" }
    }

    // ----------------------------------------------------------
    // GRAFANA
    // ----------------------------------------------------------
    ["grafana-dash"] {
      image = "grafana/grafana:latest"
      env {
        ["GF_SECURITY_ADMIN_USER"] = "admin"
        ["GF_SECURITY_ADMIN_PASSWORD"] = "admin"
      }
      volumes {
        "grafana_data:/var/lib/grafana"
      }
      ports {
        ["3001"] = 3000
      }
      dependsOn { "prometheus-metrics" }
      networks { "microservices-net" }
    }
  }
}
