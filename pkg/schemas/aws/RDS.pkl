module picklr.aws.RDS

import "../Resource.pkl"

/// An RDS Instance.
class Instance extends Resource.Resource {
  provider = "aws"

  /// The DB instance identifier.
  identifier: String

  /// The name of the database engine to be used for this instance.
  engine: String

  /// The compute and memory capacity of the DB instance.
  instanceClass: String

  /// The allocated storage size in gigabytes (GB).
  allocatedStorage: Int = 20

  /// The master username for the DB instance.
  masterUsername: String

  /// The master password for the DB instance.
  masterUserPassword: String

  properties = new {
    ["identifier"] = identifier
    ["engine"] = engine
    ["instance_class"] = instanceClass
    ["allocated_storage"] = allocatedStorage
    ["master_username"] = masterUsername
    ["master_user_password"] = masterUserPassword
  }

}

/// An RDS DB Subnet Group.
class DBSubnetGroup extends Resource.Resource {
  provider = "aws"

  /// The name of the DB subnet group.
  name: String

  /// A list of VPC subnet IDs.
  subnetIds: Listing<String>

  /// A mapping of tags to assign to the resource.
  tags: Mapping<String, String>?

  properties = new {
    ["name"] = name
    ["subnet_ids"] = subnetIds.toList()
    ["tags"] = tags
  }
}

/// An RDS DB Cluster (Aurora).
class DBCluster extends Resource.Resource {
  provider = "aws"

  /// The cluster identifier.
  identifier: String

  /// The name of the database engine to be used for this DB cluster.
  engine: String

  /// The name of the master DB user.
  masterUsername: String?

  /// The master password for the DB cluster.
  masterUserPassword: String?

  /// The name of the database to create when the DB cluster is created.
  databaseName: String?

  /// A DB subnet group to associate with this DB cluster.
  dbSubnetGroupName: String?

  /// A mapping of tags to assign to the resource.
  tags: Mapping<String, String>?

  properties = new {
    ["identifier"] = identifier
    ["engine"] = engine
    ["master_username"] = masterUsername
    ["master_user_password"] = masterUserPassword
    ["database_name"] = databaseName
    ["db_subnet_group_name"] = dbSubnetGroupName
    ["tags"] = tags
  }
}


/// An RDS DB Parameter Group.
class DBParameterGroup extends Resource.Resource {
  provider = "aws"
  
  /// The name of the parameter group.
  name: String
  
  /// The family of the parameter group.
  family: String
  
  /// The description of the parameter group.
  description: String?
  
  /// The parameters in the group.
  parameters: Listing<Parameter>?
  
  /// A mapping of tags to assign to the resource.
  tags: Mapping<String, String>?

  properties = new {
    ["name"] = name
    ["family"] = family
    ["description"] = description
    ["parameters"] = 
      if (parameters != null)
        parameters.toList().map((p) -> p.toDynamic())
      else null
    ["tags"] = tags
  }
}

class Parameter {
  name: String
  value: String
  applyMethod: String = "immediate"
  
  function toDynamic() = new Mapping {
    ["name"] = name
    ["value"] = value
    ["applyMethod"] = applyMethod
  }
}
