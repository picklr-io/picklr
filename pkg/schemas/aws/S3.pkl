module picklr.aws.S3

import "../Resource.pkl"

/// An Amazon S3 bucket.
class Bucket extends Resource.Resource {
  provider = "aws"

  /// The name of the bucket. If omitted, Picklr will assign a random, unique name.
  bucket: String?

  /// The canned ACL to apply. Defaults to "private".
  acl: String = "private"

  /// A boolean that indicates all objects should be deleted from the bucket so that the bucket can be destroyed without error.
  forceDestroy: Boolean = false

  properties = new {
    ["bucket"] = bucket
    ["acl"] = acl
    ["force_destroy"] = forceDestroy
  }
}

/// An object within an S3 bucket.
class BucketObject extends Resource.Resource {
  provider = "aws"

  /// The name of the bucket to put the object in.
  bucket: String

  /// The name of the object once it is in the bucket.
  key: String

  /// The path to the source file being uploaded to the bucket.
  source: String?

  /// The content of the object.
  content: String?

  properties = new {
    ["bucket"] = bucket
    ["key"] = key
    ["source"] = source
    ["content"] = content
  }

}

/// An Amazon S3 bucket policy.
class BucketPolicy extends Resource.Resource {
  provider = "aws"

  /// The name of the bucket to which to apply the policy.
  bucket: String

  /// The text of the policy.
  policy: String

  properties = new {
    ["bucket"] = bucket
    ["policy"] = policy
  }
}


/// S3 Bucket Lifecycle Configuration.
class BucketLifecycle extends Resource.Resource {
  provider = "aws"
  
  /// The bucket name.
  bucket: String
  
  /// The lifecycle rules.
  rules: Listing<LifecycleRule>

  properties = new {
    ["bucket"] = bucket
    ["rules"] = rules.toList().map((r) -> r.toDynamic())
  }
}

class LifecycleRule {
  id: String
  status: String = "Enabled"
  expiration: Expiration?
  
  function toDynamic() = new Mapping {
    ["id"] = id
    ["status"] = status
    ["expiration"] = if (expiration != null) expiration.toDynamic() else null
  }
}

class Expiration {
  days: Int?
  
  function toDynamic() = new Mapping {
    ["days"] = days
  }
}

/// S3 Bucket Notification.
class BucketNotification extends Resource.Resource {
  provider = "aws"
  
  /// The bucket name.
  bucket: String
  
  /// Lambda function configurations.
  lambdaFunctionConfigurations: Listing<LambdaFunctionConfiguration>?

  properties = new {
    ["bucket"] = bucket
    ["lambda_function_configurations"] = 
      if (lambdaFunctionConfigurations != null) 
        lambdaFunctionConfigurations.toList().map((c) -> c.toDynamic())
      else null
  }
}

class LambdaFunctionConfiguration {
  lambdaFunctionArn: String
  events: Listing<String>
  
  function toDynamic() = new Mapping {
    ["lambdaFunctionArn"] = lambdaFunctionArn
    ["events"] = events
  }
}
